<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feeder Analysis Dashboard (v2)</title>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root {
      --bg-page: #f0f2f5;
      --bg-card: #ffffff;
      --border-color: #d0d4db;
      --text-primary: #1a1a2e;
      --text-secondary: #5a5a7a;
      --accent-blue: #2563eb;
      --accent-green: #059669;
      --accent-amber: #d97706;
      --accent-red: #dc2626;
      --header-bg: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --radius-sm: 6px;
      --radius-md: 10px;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 14px;
      background: var(--bg-page);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .header {
      background: var(--header-bg);
      color: #fff;
      padding: 18px 20px;
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 14px;
    }

    .header h1 {
      margin: 0;
      font-size: 1.35rem;
      font-weight: 700;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .nav {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .nav a {
      color:#fff;
      text-decoration:none;
      font-weight:700;
      font-size: 0.9rem;
      opacity: 0.95;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.06);
    }
    .nav a:hover { background: rgba(255,255,255,0.12); }

    .header-meta {
      display: flex;
      gap: 18px;
      font-size: 0.9rem;
      opacity: 0.95;
      flex-wrap: wrap;
      align-items: center;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 20px 26px;
    }

    .banner {
      background: linear-gradient(90deg, #e0f2fe, #dbeafe);
      border: 1px solid #93c5fd;
      color: #0b3a78;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .banner strong { color:#0a2f60; }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 22px;
    }

    .summary-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 18px 18px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .summary-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .summary-card .label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
      font-weight: 800;
    }
    .summary-card .value {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--text-primary);
    }
    .summary-card .subtext {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .summary-card.alert { border-left: 4px solid var(--accent-amber); }
    .summary-card.good { border-left: 4px solid var(--accent-green); }
    .summary-card.info { border-left: 4px solid var(--accent-blue); }

    .charts-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 22px;
    }
    @media (max-width: 900px) {
      .charts-section { grid-template-columns: 1fr; }
    }
    .chart-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 18px 18px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    .chart-card h3 {
      margin: 0 0 14px 0;
      font-size: 1rem;
      font-weight: 800;
    }
    .chart-container {
      position: relative;
      height: 280px;
    }

    .controls-bar {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .control-group label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 800;
    }
    .control-group select,
    .control-group input[type="text"] {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      min-width: 170px;
      background: #fff;
    }
    .control-group select:focus,
    .control-group input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 800;
    }
    .btn-primary { background: var(--accent-blue); color: #fff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #e5e7eb; color: var(--text-primary); }
    .btn-secondary:hover { background: #d1d5db; }
    .btn-success { background: var(--accent-green); color: #fff; }
    .btn-success:hover { background: #047857; }
    .controls-spacer { flex: 1; }

    .table-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }
    .table-wrapper { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    thead {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th {
      padding: 14px 16px;
      text-align: left;
      font-weight: 800;
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    th:hover { background: #e2e8f0; }
    th .sort-icon { margin-left: 6px; opacity: 0.4; font-size: 0.8em; }
    th.sorted .sort-icon { opacity: 1; }
    th.sorted-asc .sort-icon::after { content: "‚ñ≤"; }
    th.sorted-desc .sort-icon::after { content: "‚ñº"; }
    th:not(.sorted) .sort-icon::after { content: "‚áÖ"; }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
    }
    tr:hover td { background: #f8fafc; }

    .row-feeder {
      background: linear-gradient(90deg, #f0f9ff 0%, #fff 100%);
      font-weight: 800;
    }
    .row-feeder td:first-child { border-left: 4px solid var(--accent-blue); }

    .imbalance-warning {
      background: linear-gradient(90deg, #fef3c7 0%, #fff 50%) !important;
    }
    .imbalance-warning td:first-child { border-left: 4px solid var(--accent-amber) !important; }
    .imbalance-badge {
      display: inline-block;
      background: var(--accent-amber);
      color: #fff;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      font-weight: 900;
    }

    .row-system-total {
      background: linear-gradient(90deg, #1e3a5f 0%, #2d5a87 100%);
      color: #fff;
      font-weight: 900;
    }
    .row-system-total td { padding: 16px; border: none; }

    .phase-cell { position: relative; }
    .phase-bar {
      position: absolute;
      bottom: 2px;
      left: 16px;
      right: 16px;
      height: 3px;
      border-radius: 2px;
      opacity: 0.6;
    }
    .phase-bar.p1 { background: var(--accent-blue); }
    .phase-bar.p2 { background: var(--accent-green); }
    .phase-bar.p3 { background: var(--accent-amber); }

    .chips {
      display: flex;
      gap: 16px;
      padding: 12px 16px;
      background: #f8fafc;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.85rem;
      flex-wrap: wrap;
    }
    .chip { color: var(--text-secondary); font-weight: 800; }
    .chip strong { color: var(--text-primary); margin-left: 4px; }

    @media print {
      .controls-bar, .charts-section, .banner, .nav { display: none !important; }
      .header { background: #1e3a5f !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>

<body>

  <header class="header">
    <div class="header-content">
      <div style="display:flex; flex-direction:column; gap:6px;">
        <h1>‚ö° Feeder Analysis Dashboard <span style="font-weight:700; opacity:.9;">(v2)</span></h1>
        <div class="header-meta">
          <span>üìÖ <span id="currentDate"></span></span>
          <span>üì¶ Source: <span id="dataSourceLabel">./data/feeder_analysis_table.json</span></span>
        </div>
      </div>

      <div class="nav">
        <a href="./index.html">Main Menu</a>
        <a href="./inventory.html">Inventory</a>
        <a href="./service.html">In Service</a>
        <a href="./pole.html">Pole Search</a>
        <a href="./serial.html">Serial Search</a>
        <a href="./reports.html">Reports</a>
      </div>
    </div>
  </header>

  <div class="container">

    <div class="banner" id="banner">
      <span style="font-size:1.3rem">üß™</span>
      <div>
        <strong>Aligned to Working Report:</strong> This v2 dashboard reads pre-calculated feeder rows from
        <code>feeder_analysis_table.json</code> so totals match your existing Feeder Statistics report.
      </div>
    </div>

    <div class="summary-grid">
      <div class="summary-card info">
        <div class="label">Total System Load</div>
        <div class="value" id="totalLoad">--</div>
        <div class="subtext">Connected kVA across all phases</div>
      </div>
      <div class="summary-card info">
        <div class="label">Transformers</div>
        <div class="value" id="totalTransformers">--</div>
        <div class="subtext">Total rows</div>
      </div>
      <div class="summary-card info">
        <div class="label">Customers</div>
        <div class="value" id="totalCustomers">--</div>
        <div class="subtext">Includes 3-phase customers</div>
      </div>
      <div class="summary-card good">
        <div class="label">Feeders</div>
        <div class="value" id="totalFeeders">--</div>
        <div class="subtext">Active</div>
      </div>
      <div class="summary-card alert" id="imbalanceCard">
        <div class="label">Imbalances</div>
        <div class="value" id="imbalanceCount">--</div>
        <div class="subtext">&gt;15% variance</div>
      </div>
    </div>

    <div class="charts-section">
      <div class="chart-card">
        <h3>üìä Load by Substation (kVA)</h3>
        <div class="chart-container">
          <canvas id="substationChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>‚öñÔ∏è System Phase Balance</h3>
        <div class="chart-container">
          <canvas id="phaseChart"></canvas>
        </div>
      </div>
    </div>

    <div class="controls-bar">
      <div class="control-group">
        <label>Substation</label>
        <select id="substationSelect"></select>
      </div>
      <div class="control-group">
        <label>Feeder</label>
        <select id="feederSelect"></select>
      </div>
      <div class="control-group">
        <label>Search</label>
        <input type="text" id="searchInput" placeholder="Search feeders...">
      </div>
      <div class="controls-spacer"></div>
      <button class="btn btn-secondary" id="btnReset">‚Ü∫ Reset</button>
      <button class="btn btn-success" id="btnExport">‚¨á Export CSV</button>
      <button class="btn btn-primary" id="btnPrint">üñ® Print</button>
    </div>

    <div class="table-card">
      <div class="chips">
        <span class="chip">Showing: <strong id="metaFeeders">--</strong> feeders</span>
        <span class="chip">Rows: <strong id="metaRows">--</strong></span>
        <span class="chip">View: <strong id="metaView">System</strong></span>
      </div>

      <div class="table-wrapper">
        <table id="reportTable">
          <thead>
            <tr>
              <th data-col="feeder">Feeder <span class="sort-icon"></span></th>
              <th data-col="p1">Phase A kVA <span class="sort-icon"></span></th>
              <th data-col="p2">Phase B kVA <span class="sort-icon"></span></th>
              <th data-col="p3">Phase C kVA <span class="sort-icon"></span></th>
              <th data-col="total">Total kVA <span class="sort-icon"></span></th>
              <th data-col="transformers">Transformers <span class="sort-icon"></span></th>
              <th data-col="customers">Customers <span class="sort-icon"></span></th>
            </tr>
          </thead>
          <tbody id="reportBody"></tbody>
          <tfoot id="reportFoot"></tfoot>
        </table>
      </div>
    </div>

  </div>

  <script>
    // ============================================================
    // CONFIGURATION
    // ============================================================
    const DATA_URL = "./data/feeder_analysis_table.json";
    const THEISS_FEEDERS = new Set([1203, 1209]);
    const FEEDER_LABEL_OVERRIDES = { 1203: "THEISS 3", 1209: "THEISS 9" };
    const IMBALANCE_THRESHOLD = 0.15;

    // ============================================================
    // STATE
    // ============================================================
    const state = {
      data: { rows: [] }, // rows are feeder-analysis records
      substation: "ALL",
      feeder: "ALL",
      search: "",
      sortCol: "feeder",
      sortDir: "asc",
      substationToFeeders: new Map(),
      feedersAll: [],
    };

    // ============================================================
    // FORMATTERS
    // ============================================================
    const fmt0 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
    const fmt2 = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmtK = (v) => v >= 1000 ? (v/1000).toFixed(1) + 'K' : fmt0.format(v);

    function n(v) { return Number.isFinite(v) ? v : 0; }

    function feederLabel(num) {
      return FEEDER_LABEL_OVERRIDES[num] ?? `Feeder ${num}`;
    }

    function substationKeyForFeeder(num) {
      if (THEISS_FEEDERS.has(num)) return "THEISS";
      return String(Math.floor(num / 100));
    }

    function substationLabel(key) {
      return key === "THEISS" ? "Theiss Substation" : `Substation ${ explain(key) }`;
      function explain(k){ return k; }
    }

    // ============================================================
    // AGGREGATION (uses feeder_analysis_table rows directly)
    // ============================================================
    function customers(r) {
      // IMPORTANT: include cust_3ph for totals
      return n(Number(r.phase1_cust)) + n(Number(r.phase2_cust)) + n(Number(r.phase3_cust)) + n(Number(r.cust_3ph));
    }

    function kvaTotal(r) {
      return n(Number(r.phase1_kva)) + n(Number(r.phase2_kva)) + n(Number(r.phase3_kva));
    }

    function hasImbalance(agg) {
      const phases = [agg.p1, agg.p2, agg.p3];
      const max = Math.max(...phases);
      const min = Math.min(...phases);
      if (max === 0) return false;
      return (max - min) / max > IMBALANCE_THRESHOLD;
    }

    function buildAgg(rows) {
      const agg = { transformers: 0, cust: 0, p1: 0, p2: 0, p3: 0, total: 0 };
      for (const r of rows) {
        agg.transformers += 1; // one row = one record in the feeder_analysis_table
        agg.cust += customers(r);
        agg.p1 += n(Number(r.phase1_kva));
        agg.p2 += n(Number(r.phase2_kva));
        agg.p3 += n(Number(r.phase3_kva));
        agg.total += kvaTotal(r);
      }
      return agg;
    }

    // ============================================================
    // FILTERING
    // ============================================================
    function allowedFeedersForSubstation(key) {
      if (key === "ALL") return null;
      return state.substationToFeeders.get(key) ?? null;
    }

    function filterRows(all) {
      const allowed = allowedFeedersForSubstation(state.substation);
      const feederSel = state.feeder;
      const q = state.search.trim().toLowerCase();

      return all.filter(r => {
        const f = Number(r.feeder);
        if (!Number.isFinite(f)) return false;

        if (allowed && !allowed.has(f)) return false;
        if (feederSel !== "ALL" && f !== Number(feederSel)) return false;
        if (q && !feederLabel(f).toLowerCase().includes(q)) return false;

        return true;
      });
    }

    // ============================================================
    // CHARTS
    // ============================================================
    let substationChart = null;
    let phaseChart = null;

    function renderCharts() {
      const all = state.data.rows;

      // Substation totals
      const substationData = new Map();
      for (const [key, feeders] of state.substationToFeeders) {
        const rows = all.filter(r => feeders.has(Number(r.feeder)));
        const agg = buildAgg(rows);
        substationData.set(key, agg.total);
      }

      const sortedSubs = Array.from(substationData.entries()).sort((a, b) => b[1] - a[1]);
      const subLabels = sortedSubs.map(([k]) => substationLabel(k));
      const subValues = sortedSubs.map(([, v]) => v);

      const ctx1 = document.getElementById('substationChart').getContext('2d');
      if (substationChart) substationChart.destroy();
      substationChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: subLabels,
          datasets: [{
            data: subValues,
            backgroundColor: [
              'rgba(37, 99, 235, 0.8)',
              'rgba(5, 150, 105, 0.8)',
              'rgba(217, 119, 6, 0.8)',
              'rgba(220, 38, 38, 0.8)',
              'rgba(139, 92, 246, 0.8)',
            ],
            borderRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { callback: v => fmtK(v) } },
            x: { ticks: { maxRotation: 45, minRotation: 0 } }
          }
        }
      });

      // Phase balance doughnut
      const totalAgg = buildAgg(all);
      const ctx2 = document.getElementById('phaseChart').getContext('2d');
      if (phaseChart) phaseChart.destroy();
      phaseChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Phase A', 'Phase B', 'Phase C'],
          datasets: [{
            data: [totalAgg.p1, totalAgg.p2, totalAgg.p3],
            backgroundColor: [
              'rgba(37, 99, 235, 0.85)',
              'rgba(5, 150, 105, 0.85)',
              'rgba(217, 119, 6, 0.85)'
            ],
            borderWidth: 3,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    }

    // ============================================================
    // SUMMARY
    // ============================================================
    function renderSummary() {
      const all = state.data.rows;
      const agg = buildAgg(all);

      document.getElementById('totalLoad').textContent = fmtK(agg.total);
      document.getElementById('totalTransformers').textContent = fmt0.format(agg.transformers);
      document.getElementById('totalCustomers').textContent = fmt0.format(agg.cust);
      document.getElementById('totalFeeders').textContent = fmt0.format(state.feedersAll.length);

      let imbalanceCount = 0;
      for (const f of state.feedersAll) {
        const rows = all.filter(r => Number(r.feeder) === f);
        if (hasImbalance(buildAgg(rows))) imbalanceCount++;
      }
      document.getElementById('imbalanceCount').textContent = imbalanceCount;

      const card = document.getElementById('imbalanceCard');
      card.classList.toggle('good', imbalanceCount === 0);
      card.classList.toggle('alert', imbalanceCount > 0);
    }

    // ============================================================
    // TABLE
    // ============================================================
    function renderTable() {
      const all = state.data.rows;
      const displayRows = filterRows(all);

      // Group by feeder
      const feederMap = new Map();
      for (const r of displayRows) {
        const f = Number(r.feeder);
        if (!Number.isFinite(f)) continue;
        if (!feederMap.has(f)) feederMap.set(f, []);
        feederMap.get(f).push(r);
      }

      // Aggregate per feeder
      let feederAggs = [];
      for (const [f, rows] of feederMap) {
        const agg = buildAgg(rows);
        feederAggs.push({ feeder: f, ...agg, imbalance: hasImbalance(agg) });
      }

      // Sort
      const col = state.sortCol;
      const dir = state.sortDir === 'asc' ? 1 : -1;
      feederAggs.sort((a, b) => {
        let va, vb;
        if (col === 'feeder') { va = a.feeder; vb = b.feeder; }
        else if (col === 'customers') { va = a.cust; vb = b.cust; }
        else { va = a[col] ?? 0; vb = b[col] ?? 0; }
        return dir * (va - vb);
      });

      const maxPhase = Math.max(...feederAggs.map(a => Math.max(a.p1, a.p2, a.p3)), 1);

      const tbody = document.getElementById('reportBody');
      tbody.innerHTML = '';

      for (const agg of feederAggs) {
        const tr = document.createElement('tr');
        tr.className = 'row-feeder' + (agg.imbalance ? ' imbalance-warning' : '');

        const badge = agg.imbalance ? '<span class="imbalance-badge">‚ö† IMBALANCE</span>' : '';
        const p1w = (agg.p1 / maxPhase * 100).toFixed(1);
        const p2w = (agg.p2 / maxPhase * 100).toFixed(1);
        const p3w = (agg.p3 / maxPhase * 100).toFixed(1);

        tr.innerHTML = `
          <td><strong>${feederLabel(agg.feeder)}</strong>${badge}</td>
          <td class="phase-cell">${fmt2.format(agg.p1)}<div class="phase-bar p1" style="width:${p1w}%"></div></td>
          <td class="phase-cell">${fmt2.format(agg.p2)}<div class="phase-bar p2" style="width:${p2w}%"></div></td>
          <td class="phase-cell">${fmt2.format(agg.p3)}<div class="phase-bar p3" style="width:${p3w}%"></div></td>
          <td><strong>${fmt2.format(agg.total)}</strong></td>
          <td>${fmt0.format(agg.transformers)}</td>
          <td>${fmt0.format(agg.cust)}</td>
        `;
        tbody.appendChild(tr);
      }

      // Footer total (substation view total)
      const allowed = allowedFeedersForSubstation(state.substation);
      const totalRows = allowed ? all.filter(r => allowed.has(Number(r.feeder))) : all;
      const totalAgg = buildAgg(totalRows);
      const label = state.substation === "ALL" ? "System Total" : `${substationLabel(state.substation)} Total`;

      document.getElementById('reportFoot').innerHTML = `
        <tr class="row-system-total">
          <td>${label}</td>
          <td>${fmt2.format(totalAgg.p1)}</td>
          <td>${fmt2.format(totalAgg.p2)}</td>
          <td>${fmt2.format(totalAgg.p3)}</td>
          <td>${fmt2.format(totalAgg.total)}</td>
          <td>${fmt0.format(totalAgg.transformers)}</td>
          <td>${fmt0.format(totalAgg.cust)}</td>
        </tr>
      `;

      document.getElementById('metaFeeders').textContent = fmt0.format(feederAggs.length);
      document.getElementById('metaRows').textContent = fmt0.format(displayRows.length);
      document.getElementById('metaView').textContent =
        state.substation === "ALL" ? "System" : substationLabel(state.substation);

      document.querySelectorAll('th[data-col]').forEach(th => {
        th.classList.remove('sorted', 'sorted-asc', 'sorted-desc');
        if (th.dataset.col === state.sortCol) th.classList.add('sorted', `sorted-${state.sortDir}`);
      });
    }

    // ============================================================
    // EXPORT
    // ============================================================
    function exportCSV() {
      const displayRows = filterRows(state.data.rows);
      const feederMap = new Map();
      for (const r of displayRows) {
        const f = Number(r.feeder);
        if (!Number.isFinite(f)) continue;
        if (!feederMap.has(f)) feederMap.set(f, []);
        feederMap.get(f).push(r);
      }

      let csv = 'Feeder,Phase A kVA,Phase B kVA,Phase C kVA,Total kVA,Transformers,Customers\n';
      for (const [f, rows] of feederMap) {
        const agg = buildAgg(rows);
        csv += `"${feederLabel(f)}",${agg.p1.toFixed(2)},${agg.p2.toFixed(2)},${agg.p3.toFixed(2)},${agg.total.toFixed(2)},${agg.transformers},${agg.cust}\n`;
      }

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `feeder-analysis-v2-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============================================================
    // INIT
    // ============================================================
    async function loadFeederAnalysisTable() {
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Failed to load feeder_analysis_table.json (HTTP ${res.status})`);
      return await res.json();
    }

    function buildIndex() {
      state.substationToFeeders = new Map();
      const feeders = [...new Set(state.data.rows.map(r => Number(r.feeder)))]
        .filter(Number.isFinite)
        .sort((a, b) => a - b);

      state.feedersAll = feeders;

      for (const f of feeders) {
        const key = substationKeyForFeeder(f);
        if (!state.substationToFeeders.has(key)) state.substationToFeeders.set(key, new Set());
        state.substationToFeeders.get(key).add(f);
      }
    }

    function fillSubstationSelect() {
      const sel = document.getElementById('substationSelect');
      sel.innerHTML = '<option value="ALL">All Substations</option>';

      const keys = [...state.substationToFeeders.keys()];
      const numeric = keys.filter(k => k !== "THEISS").map(Number).sort((a, b) => a - b).map(String);

      for (const k of numeric) sel.innerHTML += `<option value="${k}">${substationLabel(k)}</option>`;
      if (state.substationToFeeders.has("THEISS")) sel.innerHTML += `<option value="THEISS">${substationLabel("THEISS")}</option>`;
    }

    function fillFeederSelect() {
      const sel = document.getElementById('feederSelect');
      sel.innerHTML = '<option value="ALL">All Feeders</option>';

      const allowed = allowedFeedersForSubstation(state.substation);
      const feeders = allowed ? [...allowed].sort((a, b) => a - b) : state.feedersAll;

      for (const f of feeders) sel.innerHTML += `<option value="${f}">${feederLabel(f)}</option>`;

      if (state.feeder !== "ALL" && allowed && !allowed.has(Number(state.feeder))) state.feeder = "ALL";
      sel.value = state.feeder;
    }

    function wireEvents() {
      document.getElementById('substationSelect').addEventListener('change', e => {
        state.substation = e.target.value;
        state.feeder = "ALL";
        state.search = "";
        document.getElementById('searchInput').value = "";
        fillFeederSelect();
        renderTable();
      });

      document.getElementById('feederSelect').addEventListener('change', e => {
        state.feeder = e.target.value;
        renderTable();
      });

      document.getElementById('searchInput').addEventListener('input', e => {
        state.search = e.target.value;
        renderTable();
      });

      document.getElementById('btnReset').addEventListener('click', () => {
        state.substation = "ALL";
        state.feeder = "ALL";
        state.search = "";
        state.sortCol = "feeder";
        state.sortDir = "asc";
        document.getElementById('substationSelect').value = "ALL";
        document.getElementById('searchInput').value = "";
        fillFeederSelect();
        renderTable();
      });

      document.getElementById('btnExport').addEventListener('click', exportCSV);
      document.getElementById('btnPrint').addEventListener('click', () => window.print());

      document.querySelectorAll('th[data-col]').forEach(th => {
        th.addEventListener('click', () => {
          const col = th.dataset.col;
          if (state.sortCol === col) state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
          else { state.sortCol = col; state.sortDir = 'asc'; }
          renderTable();
        });
      });
    }

    async function init() {
      document.getElementById('currentDate').textContent =
        new Date().toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });

      try {
        const raw = await loadFeederAnalysisTable();
        state.data.rows = Array.isArray(raw) ? raw : (raw.rows ?? raw.data ?? []);

        buildIndex();
        fillSubstationSelect();
        fillFeederSelect();
        wireEvents();

        renderSummary();
        renderCharts();
        renderTable();
      } catch (err) {
        console.error(err);
        const banner = document.getElementById('banner');
        if (banner) {
          banner.innerHTML =
            `<span style="font-size:1.3rem">‚ùå</span><div><strong>Failed to load data.</strong><div style="opacity:.9;margin-top:4px;">${String(err.message || err)}</div></div>`;
        }
      }
    }

    init();
  </script>

</body>
</html>
